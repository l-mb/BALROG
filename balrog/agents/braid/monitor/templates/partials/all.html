<div class="layout" data-max-step="{{ max_step }}" data-current-step="{{ current_step if current_step else '' }}">
  <!-- Main two-column layout -->
  <div class="main-columns">
    <!-- Left column: Screen + Memory -->
    <div class="left-column">
      <article class="screen-panel">
        <header>Screen</header>
        {% if screen %}
        <pre class="screen">{{ screen }}</pre>
        {% else %}
        <p class="muted">No screen data (yet)</p>
        {% endif %}
      </article>

      <article class="memory-panel">
        <header>
          {% set p_count = entries|selectattr('scope', 'equalto', 'persistent')|list|length %}
          {% set e_count = entries|selectattr('scope', 'equalto', 'episode')|list|length %}
          <span>Memory ({{ p_count }}p + {{ e_count }}e{% if show_deleted %}, {{ entries|selectattr('deleted')|list|length }} deleted{% endif %})</span>
          <div class="memory-controls">
            <select class="memory-scope-select"
                    onchange="updateMemoryFilter()">
              <option value="all" {% if memory_scope == 'all' %}selected{% endif %}>All</option>
              <option value="persistent" {% if memory_scope == 'persistent' %}selected{% endif %}>Persistent</option>
              <option value="episode" {% if memory_scope == 'episode' %}selected{% endif %}>Episode</option>
            </select>
            <label class="memory-deleted-toggle">
              <input type="checkbox" {% if show_deleted %}checked{% endif %}
                     onchange="updateMemoryFilter()">
              Deleted
            </label>
          </div>
        </header>
        <div class="memory-list">
          {% if entries %}
          <table>
            <thead>
              <tr>
                <th class="col-step">@</th>
                <th class="col-prio">P</th>
                <th class="col-tags">Tags</th>
                <th class="col-content">Content</th>
              </tr>
            </thead>
            <tbody>
              {% for e in entries %}
              <tr class="{% if e.deleted %}deleted-entry{% endif %}{% if e.scope == 'persistent' %} persistent-entry{% endif %}">
                <td class="col-step">{{ e.source_step if e.source_step is not none else '-' }}</td>
                <td class="col-prio">{{ e.priority }}</td>
                <td class="col-tags">{% for tag in e.tags.split(',') %}<span class="tag">{{ tag.strip() }}</span>{% endfor %}</td>
                <td class="col-content"><pre>{{ e.content }}</pre></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <p class="muted">No memory entries</p>
          {% endif %}
        </div>
      </article>
    </div>

    <!-- Right column: History + Stats (top), Response (bottom) -->
    <div class="right-column">
      <div class="right-top">
        <article class="history-panel">
          <header>History ({{ responses|length if responses else 0 }})</header>
          <div class="history-list">
            {% if responses and responses|length > 0 %}
            <table class="history-table">
              <thead>
                <tr>
                  <th class="col-step">#</th>
                  <th class="col-action">Action</th>
                  <th class="col-reasoning">Reasoning</th>
                </tr>
              </thead>
              <tbody>
                {% for r in responses %}
                <tr>
                  <td class="col-step">{{ r.step }}</td>
                  <td class="col-action"><code>{{ r.action|default('?', true) }}</code>{% if r.compute_requests %}<br><span class="compute-tag">+compute</span>{% endif %}</td>
                  <td class="col-reasoning"><pre>{% if r.action_type == 'queued' %}(queued){% elif r.reasoning %}{{ r.reasoning }}{% else %}(no reasoning){% endif %}{% if r.compute_requests %}
---
{% for req in r.compute_requests %}{{ req }}
{% endfor %}{% endif %}</pre></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <p class="muted">No actions yet</p>
            {% endif %}
          </div>
        </article>

        <article class="stats-panel">
          <header>Stats</header>
          {% if stats %}
          <dl>
            <dt>Episode</dt>
            <dd>{{ stats.episode }}</dd>
            <dt>Step</dt>
            <dd>{{ stats.step }}</dd>
            <dt>Tokens In</dt>
            <dd>{{ "{:,}".format(stats.total_in_tokens) }}</dd>
            <dt>Tokens Out</dt>
            <dd>{{ "{:,}".format(stats.total_out_tokens) }}</dd>
            <dt>Cache Read</dt>
            <dd>{{ "{:,}".format(stats.cache_read_tokens) }}{% if stats.total_in_tokens %} ({{ "{:.0f}".format(100 * stats.cache_read_tokens / stats.total_in_tokens) }}%){% endif %}</dd>
            <dt>Cache Create</dt>
            <dd>{{ "{:,}".format(stats.cache_create_tokens) }}</dd>
            <dt>Avg Latency</dt>
            <dd>{{ "{:.1f}".format(stats.avg_latency_ms / 1000) }}s</dd>
            <dt>Actions</dt>
            <dd>{{ stats.single_actions }}s + {{ stats.multi_actions }}m + {{ stats.queued_actions }}q</dd>
            <dt>Memory</dt>
            <dd>+{{ stats.episode_mem_adds }}/-{{ stats.episode_mem_removes }}e, +{{ stats.persistent_mem_adds }}/-{{ stats.persistent_mem_removes }}p</dd>
            <dt>Think</dt>
            <dd>{{ stats.think_count }}/{{ stats.single_actions + stats.multi_actions }} ({{ "{:.0f}".format(100 * stats.think_count / (stats.single_actions + stats.multi_actions)) if (stats.single_actions + stats.multi_actions) else 0 }}%)</dd>
            <dt>Compute</dt>
            <dd>{{ stats.compute_count }}</dd>
          </dl>
          {% else %}
          <p class="muted">No stats</p>
          {% endif %}
        </article>
      </div>

      <article class="response-panel">
        <header>Response{% if full_response %} ({{ full_response.in_tok }}/{{ full_response.out_tok }} tok){% endif %}</header>
        <div class="debug-content">
          {% if full_response %}
          {% if full_response.extended_thinking %}
          <div class="debug-message debug-role-thinking">
            <div class="debug-role">extended thinking</div>
            <pre>{{ full_response.extended_thinking }}</pre>
          </div>
          {% endif %}
          {% if full_response.reasoning %}
          <div class="debug-message">
            <div class="debug-role">reasoning (&lt;think&gt;)</div>
            <pre>{{ full_response.reasoning }}</pre>
          </div>
          {% endif %}
          <div class="debug-message">
            <div class="debug-role">action</div>
            <pre>{{ full_response.action }}</pre>
          </div>
          {% else %}
          <p class="muted">No response yet</p>
          {% endif %}
        </div>
      </article>
    </div>
  </div>

  <!-- Debug: Full Prompt -->
  <article class="prompt-panel">
    <header>Full Prompt{% if full_prompt %} (step {{ full_prompt.step }}, {{ full_prompt.messages|length }} messages){% endif %}</header>
    <div class="debug-content">
      {% if full_prompt and full_prompt.messages %}
      {% for msg in full_prompt.messages %}
      <div class="debug-message debug-role-{{ msg.role }}">
        <div class="debug-role">{{ msg.role }}</div>
        <pre>{{ msg.content }}</pre>
      </div>
      {% endfor %}
      {% else %}
      <p class="muted">No prompt logged (enable log_full_prompt in config)</p>
      {% endif %}
    </div>
  </article>
</div>
