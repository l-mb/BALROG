<!-- Stats table - out-of-band swap to avoid flickering nav controls -->
<div id="stats-content" hx-swap-oob="innerHTML">
  {% if stats %}
  <table class="stats-table">
    <thead>
      <tr>
        <th>Ep</th>
        <th>Step</th>
        <th>LLM</th>
        <th>In</th>
        <th>Out</th>
        <th>Cache</th>
        <th>Lat</th>
        <th>Act</th>
        <th>Mem</th>
        <th>Model</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{ stats.episode }}</td>
        <td>{{ stats.step }}</td>
        <td>{{ stats.llm_calls }}</td>
        <td>{{ "{:,}".format(stats.total_in_tokens) }}</td>
        <td>{{ "{:,}".format(stats.total_out_tokens) }}</td>
        <td>{{ "{:,}".format(stats.cache_read_tokens) }}{% if stats.total_in_tokens %} ({{ "{:.0f}".format(100 * stats.cache_read_tokens / stats.total_in_tokens) }}%){% endif %}</td>
        <td>{{ "{:.1f}".format(stats.avg_latency_ms / 1000) }}s</td>
        <td>{{ stats.single_actions }}s+{{ stats.multi_actions }}m+{{ stats.queued_actions }}q</td>
        <td>+{{ stats.episode_mem_adds }}/-{{ stats.episode_mem_removes }}e +{{ stats.persistent_mem_adds }}/-{{ stats.persistent_mem_removes }}p</td>
        <td>{{ stats.model_id or '-' }}</td>
      </tr>
    </tbody>
  </table>
  {% else %}
  <span class="muted">No stats</span>
  {% endif %}
</div>

<div class="layout" data-max-step="{{ max_step }}" data-current-step="{{ current_step if current_step else '' }}">

  <!-- Main two-column layout -->
  <div class="main-columns">
    <!-- Left column: Screen + Memory -->
    <div class="left-column">
      <article class="screen-panel">
        <header>Screen{% if visited_count %} ({{ visited_count }} visited){% endif %}</header>
        {% if screen_rows %}
        <pre class="screen">{% for row in screen_rows %}{% for char, is_visited in row %}{% if is_visited %}<span class="visited">{{ char }}</span>{% else %}{{ char }}{% endif %}{% endfor %}
{% endfor %}</pre>
        {% elif screen %}
        <pre class="screen">{{ screen }}</pre>
        {% else %}
        <p class="muted">No screen data (yet)</p>
        {% endif %}
      </article>

      <article class="memory-panel">
        <header>
          {% set p_count = entries|selectattr('scope', 'equalto', 'persistent')|list|length %}
          {% set e_count = entries|selectattr('scope', 'equalto', 'episode')|list|length %}
          <span>Memory ({{ p_count }}p + {{ e_count }}e{% if show_deleted %}, {{ entries|selectattr('deleted')|list|length }} deleted{% endif %})</span>
          <div class="memory-controls">
            <select class="memory-scope-select"
                    onchange="updateMemoryFilter()">
              <option value="all" {% if memory_scope == 'all' %}selected{% endif %}>All</option>
              <option value="persistent" {% if memory_scope == 'persistent' %}selected{% endif %}>Persistent</option>
              <option value="episode" {% if memory_scope == 'episode' %}selected{% endif %}>Episode</option>
            </select>
            <label class="memory-deleted-toggle">
              <input type="checkbox" {% if show_deleted %}checked{% endif %}
                     onchange="updateMemoryFilter()">
              Deleted
            </label>
          </div>
        </header>
        <div class="memory-list">
          {% if entries %}
          <table>
            <thead>
              <tr>
                <th class="col-step">@</th>
                <th class="col-prio">P</th>
                <th class="col-tags">Tags</th>
                <th class="col-content">Content</th>
              </tr>
            </thead>
            <tbody>
              {% for e in entries %}
              <tr class="{% if e.deleted %}deleted-entry{% endif %}{% if e.scope == 'persistent' %} persistent-entry{% endif %}">
                <td class="col-step">{{ e.source_step if e.source_step is not none else '-' }}</td>
                <td class="col-prio">{{ e.priority }}</td>
                <td class="col-tags">{% for tag in e.tags.split(',') %}<span class="tag">{{ tag.strip() }}</span>{% endfor %}</td>
                <td class="col-content"><pre>{{ e.content }}</pre></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <p class="muted">No memory entries</p>
          {% endif %}
        </div>
      </article>
    </div>

    <!-- Right column: Tools, Todos, Conversation -->
    <div class="right-column">
      <!-- Todo list panel -->
      {% if todos %}
      <article class="todo-panel">
        <header>
          {% set pending = todos|selectattr('status', 'equalto', 'pending')|list|length %}
          {% set in_progress = todos|selectattr('status', 'equalto', 'in_progress')|list|length %}
          {% set completed = todos|selectattr('status', 'equalto', 'completed')|list|length %}
          Todos ({{ completed }}/{{ todos|length }})
          <div class="todo-progress">
            <span class="todo-bar" style="width: {{ (100 * completed / todos|length)|int if todos else 0 }}%"></span>
          </div>
        </header>
        <div class="todo-list">
          {% for todo in todos %}
          <div class="todo-item todo-{{ todo.status }}">
            <span class="todo-status">{% if todo.status == 'completed' %}✓{% elif todo.status == 'in_progress' %}▶{% else %}○{% endif %}</span>
            <span class="todo-content">{{ todo.activeForm if todo.status == 'in_progress' else todo.content }}</span>
          </div>
          {% endfor %}
        </div>
      </article>
      {% endif %}

      <article class="conversation-panel">
        <header>
          Conversation
          {% if using_sdk and sdk_history %}
          (SDK, {{ sdk_history|length }} turns)
          {% elif full_prompt %}
          (step {{ full_prompt.step }}, {{ full_prompt.messages|length }} msgs)
          {% endif %}
          {% if full_response %} · {{ full_response.in_tok }}/{{ full_response.out_tok }} tok{% endif %}
        </header>
        <div class="conversation-content">
          {% if using_sdk and sdk_history %}
          <!-- SDK: Show all turns with their tool calls (newest first) -->
          {% for turn in sdk_history %}
          <div class="conv-turn {% if loop.first %}conv-latest{% endif %}">
            <div class="conv-msg conv-assistant">
              <span class="conv-role">← assistant (step {{ turn.step }})</span>
              <pre>{{ turn.received }}</pre>
            </div>
            {% set step_tools = tool_calls_by_step.get(turn.step, []) %}
            {% if step_tools %}
            <div class="conv-msg conv-actions">
              <span class="conv-role">⚡ actions & tools</span>
              <div class="actions-content">
                {% for tc in step_tools %}
                <div class="tool-item {% if tc.error %}tool-error{% endif %}">
                  <span class="tool-label">{{ tc.tool_name }}</span>
                  {% if tc.args %}
                  <span class="tool-args">{{ tc.args if tc.args is string else tc.args|tojson }}</span>
                  {% endif %}
                  {% if tc.result %}<span class="tool-result">→ {{ tc.result|truncate(120) }}</span>{% endif %}
                  {% if tc.error %}<span class="tool-error-msg">✗ {{ tc.error }}</span>{% endif %}
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            <div class="conv-msg conv-user">
              <span class="conv-role">→ sent</span>
              <pre>{{ turn.sent }}</pre>
            </div>
          </div>
          {% if not loop.last %}
          <div class="conv-separator">──</div>
          {% endif %}
          {% endfor %}
          {% elif full_prompt and full_prompt.messages %}
          <!-- Traditional: Show messages, newest at top -->
          {% if full_response and full_response.extended_thinking %}
          <div class="conv-msg conv-thinking">
            <span class="conv-role">thinking</span>
            <pre>{{ full_response.extended_thinking }}</pre>
          </div>
          {% endif %}
          {% if full_response and full_response.raw_completion %}
          <div class="conv-msg conv-assistant conv-latest-single">
            <span class="conv-role">← assistant (latest)</span>
            <pre>{{ full_response.raw_completion }}</pre>
          </div>
          {% endif %}
          <div class="conv-separator">── prompt ──</div>
          {% for msg in full_prompt.messages|reverse %}
          <div class="conv-msg conv-{{ msg.role }}">
            <span class="conv-role">{{ msg.role }}</span>
            <pre>{{ msg.content }}</pre>
          </div>
          {% endfor %}
          {% else %}
          <p class="muted">No conversation yet</p>
          {% endif %}
        </div>
      </article>
    </div>
  </div>
</div>
